<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastrar Imóvel - Acomoda</title>
  <link rel="stylesheet" href="../assets/css/components/navbar.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Urbanist', sans-serif;
    }

    body {
      background-color: #ffffff;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 80px auto 30px;
      padding: 30px;
    }

    h1 {
      font-size: 2.2rem;
      color: #333;
      margin-bottom: 10px;
    }

    .subtitle {
      font-size: 1.2rem;
      color: #666;
      margin-bottom: 30px;
    }

    .form-container {
      background-color: #f0f0f0;
      border: 2px solid #ccc;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .form-section {
      margin-bottom: 25px;
    }

    .section-title {
      color: #4a7c59;
      font-size: 1.5rem;
      margin-bottom: 15px;
      border-bottom: 1px solid #ccc;
      padding-bottom: 8px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 16px;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .file-input-container {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      border: 2px dashed #ccc;
      padding: 20px;
      border-radius: 10px;
      margin-top: 10px;
    }

    .file-input-container img {
      max-width: 200px;
      max-height: 200px;
      display: none;
    }

    .file-input {
      margin-top: 10px;
    }

    .file-input-label {
      background-color: #1c6155;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      text-align: center;
    }

    .preview-images {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }

    .preview-image {
      width: 150px;
      height: 150px;
      border-radius: 8px;
      border: 1px solid #ccc;
      object-fit: cover;
    }

    .submit-btn {
      background-color: #1c6155;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      display: block;
      margin: 20px auto;
      transition: background-color 0.3s;
    }

    .submit-btn:hover {
      background-color: #154a40;
    }

    .required:after {
      content: " *";
      color: #e74c3c;
    }

    .form-group.half {
      width: 48%;
      display: inline-block;
      margin-right: 2%;
    }

    @media (max-width: 768px) {
      .form-group.half {
        width: 100%;
        margin-right: 0;
      }
    }
  </style>
</head>
<body>
  <div id="navbar"></div>

  <div class="container">
    <h1>Cadastrar Novo Imóvel</h1>
    <p class="subtitle">Preencha os detalhes do imóvel que deseja cadastrar na plataforma.</p>

    <form id="cadastrarCasaForm">
      <div class="form-container">
        <div class="form-section">
          <h2 class="section-title">Informações Básicas</h2>
          
          <div class="form-group">
            <label for="nome" class="required">Nome do imóvel</label>
            <input type="text" id="nome" name="nome" required placeholder="Ex: Apartamento 302 Residencial Primavera">
          </div>
          
          <div class="form-group half">
            <label for="valor" class="required">Valor do aluguel (R$)</label>
            <input type="number" id="valor" name="valor" step="0.01" min="0" required placeholder="Ex: 800.00">
          </div>
          
          <div class="form-group half">
            <label for="userProprietario" class="required">Usuário proprietário</label>
            <input type="text" id="userProprietario" name="userProprietario" required placeholder="Digite seu nome de usuário">
          </div>
        </div>

        <div class="form-section">
          <h2 class="section-title">Descrição e Detalhes</h2>
          
          <div class="form-group">
            <label for="descricao" class="required">Descrição completa</label>
            <textarea id="descricao" name="descricao" required placeholder="Descreva detalhes como número de quartos, banheiros, área, localização, etc."></textarea>
          </div>
          
          <div class="form-group">
            <label for="observacao">Observações adicionais</label>
            <textarea id="observacao" name="observacao" placeholder="Informações adicionais como regras da casa, contas inclusas, etc."></textarea>
          </div>
        </div>

        <div class="form-section">
          <h2 class="section-title">Imagens</h2>
          
          <div class="form-group">
            <label for="fotoPrincipal" class="required">Foto principal</label>
            <div class="file-input-container">
              <img id="fotoPrincipalPreview" alt="Preview da foto principal">
              <input type="file" id="fotoPrincipal" name="fotoPrincipal" class="file-input" accept="image/*" required>
              <span class="file-input-label">Selecionar Foto Principal</span>
            </div>
          </div>
          
          <div class="form-group">
            <label for="fotosAdicionais">Fotos adicionais</label>
            <div class="file-input-container">
              <div class="preview-images" id="fotosPreview"></div>
              <input type="file" id="fotosAdicionais" name="fotosAdicionais" class="file-input" accept="image/*" multiple>
              <span class="file-input-label">Selecionar Fotos Adicionais (máx. 5)</span>
            </div>
          </div>
        </div>
      </div>

      <button type="submit" class="submit-btn">Cadastrar Imóvel</button>
    </form>
  </div>

  <script src="../assets/js/main.js"></script>
  <script>
    // Visualização prévia da foto principal
    document.getElementById('fotoPrincipal').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          const preview = document.getElementById('fotoPrincipalPreview');
          preview.src = event.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });

    // Visualização prévia das fotos adicionais
    document.getElementById('fotosAdicionais').addEventListener('change', function(e) {
      const files = e.target.files;
      const preview = document.getElementById('fotosPreview');
      preview.innerHTML = '';
      
      // Limitar a 5 imagens
      const maxFiles = Math.min(files.length, 5);
      
      for (let i = 0; i < maxFiles; i++) {
        const file = files[i];
        const reader = new FileReader();
        
        reader.onload = function(event) {
          const img = document.createElement('img');
          img.src = event.target.result;
          img.className = 'preview-image';
          preview.appendChild(img);
        };
        
        reader.readAsDataURL(file);
      }
    });

    // Buscar usuários disponíveis
    async function carregarUsuarios() {
      try {
        const response = await fetch('/users');
        if (response.ok) {
          const usuarios = await response.json();
          const select = document.getElementById('userProprietario');
          
          // Converter o input para um select
          const inputField = document.getElementById('userProprietario');
          const parentDiv = inputField.parentElement;
          
          // Criar select
          const selectField = document.createElement('select');
          selectField.id = 'userProprietario';
          selectField.name = 'userProprietario';
          selectField.required = true;
          selectField.classList = inputField.classList;
          
          // Adicionar opção padrão
          const defaultOption = document.createElement('option');
          defaultOption.text = 'Selecione um usuário';
          defaultOption.value = '';
          selectField.appendChild(defaultOption);
          
          // Adicionar usuários como opções
          usuarios.forEach(usuario => {
            const option = document.createElement('option');
            option.value = usuario.user;
            option.text = usuario.user + (usuario.nome ? ` (${usuario.nome})` : '');
            selectField.appendChild(option);
          });
          
          // Substituir o input pelo select
          parentDiv.replaceChild(selectField, inputField);
          
        } else {
          console.error('Erro ao buscar usuários');
        }
      } catch (error) {
        console.error('Erro ao carregar usuários:', error);
      }
    }

    // Carregar usuários ao iniciar a página
    document.addEventListener('DOMContentLoaded', carregarUsuarios);

    // Envio do formulário
    document.getElementById('cadastrarCasaForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Capturar os valores do formulário
      const formData = new FormData();
      formData.append('nome', document.getElementById('nome').value);
      formData.append('valor', document.getElementById('valor').value);
      formData.append('userProprietario', document.getElementById('userProprietario').value);
      formData.append('descricao', document.getElementById('descricao').value);
      formData.append('observacao', document.getElementById('observacao').value);
      
      // Adicionar a foto principal
      const fotoPrincipal = document.getElementById('fotoPrincipal').files[0];
      formData.append('fotoPrincipal', fotoPrincipal);
      
      try {
        // Exibir mensagem de carregamento
        const submitBtn = document.querySelector('.submit-btn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Enviando...';
        submitBtn.disabled = true;
        
        // Fazer a requisição para a API
        const response = await fetch('/api/casas', {
          method: 'POST',
          body: formData,
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => null);
          const errorMessage = errorData?.message || 'Erro ao cadastrar imóvel. Tente novamente.';
          alert(errorMessage);
        } else {
          const resultado = await response.json();
          console.log('Cadastro realizado com sucesso:', resultado);
          alert('Imóvel cadastrado com sucesso!');
          
          // Após cadastrar com sucesso, redirecionar para a página principal
          window.location.href = '/pages/main_screen.html';
        }
        
      } catch (error) {
        console.error('Erro ao cadastrar imóvel:', error);
        alert(`Erro ao cadastrar imóvel: ${error.message || 'Erro desconhecido'}`);
      } finally {
        // Restaurar o texto original do botão
        const submitBtn = document.querySelector('.submit-btn');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
